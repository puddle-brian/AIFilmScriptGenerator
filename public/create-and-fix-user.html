<!DOCTYPE html>
<html>
<head>
    <title>Create & Fix User</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover {
            background: #45a049;
        }
        .debug-info {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <h1>Create & Fix User Account</h1>
    <p>This will create the user if they don't exist, then populate their starter pack and grant credits.</p>
    
    <button class="button" onclick="createAndFixUser('testuser54321')">Fix testuser54321</button>
    <button class="button" onclick="createAndFixUser('CCKRAD')">Fix CCKRAD</button>
    
    <div id="results"></div>

    <script>
    async function createAndFixUser(username) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `<div class="debug-info">Starting fix for ${username}...</div>`;
        
                 try {
             // Step 1: Check if user exists, create if needed
             console.log(`Step 1: Checking if user ${username} exists...`);
             let userExists = true;
             let registerResponse = { status: 200 };
             let registerResult = 'User already exists';
             
             // Try to populate starter pack first to see if user exists
             const testResponse = await fetch(`/api/user-libraries/${username}/populate-starter-pack`, {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json'
                 }
             });
             
             if (testResponse.status === 404) {
                 // User doesn't exist, try to create them
                 console.log(`User ${username} doesn't exist, creating...`);
                 userExists = false;
                 registerResponse = await fetch('/api/auth/register', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({ 
                         username: username,
                         email: `${username}@example.com`,
                         password: 'temppassword123'
                     })
                 });
                 
                 registerResult = await registerResponse.text();
                 console.log('Register response:', registerResponse.status, registerResult);
             }
             
             resultsDiv.innerHTML += `
                 <div class="debug-info">
                     <strong>Step 1 - User Check/Creation:</strong>
                     Status: ${registerResponse.status}
                     Response: ${registerResult}
                     ${userExists ? '(User already existed)' : '(Created new user)'}
                 </div>
             `;
             
             // Step 2: Populate starter pack (do this regardless of whether user was created or existed)
             console.log(`Step 2: Populating starter pack for ${username}...`);
             const starterResponse = await fetch(`/api/user-libraries/${username}/populate-starter-pack`, {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json'
                 }
             });
             
             const starterResult = await starterResponse.text();
             console.log('Starter pack response:', starterResponse.status, starterResult);
             
             resultsDiv.innerHTML += `
                 <div class="debug-info">
                     <strong>Step 2 - Starter Pack:</strong>
                     Status: ${starterResponse.status}
                     Response: ${starterResult}
                 </div>
             `;
             
             // Final summary
             const allSuccessful = registerResponse.status < 400 && 
                                 starterResponse.status < 400;
            
                         resultsDiv.innerHTML += `
                 <div class="debug-info ${allSuccessful ? 'success' : 'error'}">
                     <strong>FINAL RESULT:</strong>
                     ${allSuccessful ? '✅ SUCCESS! User ' + username + ' has been created and starter pack populated. Note: Credits need to be granted separately by an admin.' : '❌ Some steps failed. Check the details above.'}
                 </div>
             `;
            
        } catch (error) {
            console.error('Error:', error);
            resultsDiv.innerHTML += `
                <div class="debug-info error">
                    <strong>JavaScript Error:</strong>
                    ${error.message}
                    ${error.stack}
                </div>
            `;
        }
    }
    </script>
</body>
</html> 